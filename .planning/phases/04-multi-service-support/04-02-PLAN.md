---
phase: 04-multi-service-support
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - src/services/ai/stability.ts
  - src/services/ai/factory.ts
autonomous: true
requirements: [AI-03]

must_haves:
  truths:
    - "User can generate images using Stability AI when API key is configured"
    - "Tool validates Stability API key exists before attempting generation"
    - "Stability temp files are cleaned up after buffer extraction"
  artifacts:
    - path: "src/services/ai/stability.ts"
      provides: "Stability AI service adapter"
      exports: ["StabilityService"]
      min_lines: 90
    - path: "src/services/ai/factory.ts"
      provides: "Stability case in factory switch"
      contains: "case 'stability':"
  key_links:
    - from: "src/services/ai/stability.ts"
      to: "stability-ai SDK"
      via: "import StabilityAI from 'stability-ai'"
      pattern: "import.*stability-ai"
    - from: "src/services/ai/factory.ts"
      to: "src/services/ai/stability.ts"
      via: "case 'stability': return new StabilityService"
      pattern: "case 'stability'"
    - from: "src/services/ai/stability.ts"
      to: "AIServiceAdapter interface"
      via: "implements AIServiceAdapter"
      pattern: "implements AIServiceAdapter"
---

<objective>
Add Stability AI as second paid AI provider option, completing the multi-service support and validating that the Strategy pattern enables provider additions with zero orchestration changes.

Purpose: Provides alternative paid service for users preferring Stability AI's models, and proves the service abstraction architecture scales to multiple providers without workflow modifications.

Output: Stability service adapter integrated into factory, enabling three-provider ecosystem (Hugging Face free, OpenAI paid, Stability paid).
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-multi-service-support/04-RESEARCH.md
@.planning/phases/04-multi-service-support/04-01-SUMMARY.md
@src/services/ai/types.ts
@src/services/ai/factory.ts
@src/services/ai/openai.ts
@src/services/ai/huggingface.ts
@src/services/config.ts
@src/services/errors.ts
</context>

<tasks>

<task type="auto">
  <name>Create Stability AI Service Adapter</name>
  <files>src/services/ai/stability.ts</files>
  <action>
Create StabilityService implementing AIServiceAdapter interface, following OpenAIService pattern from Plan 01 with Stability-specific adjustments.

Implementation requirements (from RESEARCH.md lines 148-230):

1. **Import and constructor:**
```typescript
import StabilityAI from 'stability-ai';
import { readFile, unlink } from 'node:fs/promises';
import type { AIServiceAdapter, GenerationResult } from './types.js';
import { AIServiceError } from '../errors.js';

export class StabilityService implements AIServiceAdapter {
  private client: StabilityAI;

  constructor(apiKey: string) {
    this.client = new StabilityAI(apiKey);
  }
```

Note: Need readFile and unlink because SDK saves to filesystem (research pitfall 4, lines 359-365).

2. **Interface methods:**
- getServiceName(): return 'Stability'
- requiresApiKey(): return true (Stability requires API key)
- getTimeout(): return 90000 (90 seconds - slower than OpenAI, free tier can be slow)

3. **generateImage implementation:**
- Use `client.v1.generation.textToImage()` with engine='stable-diffusion-xl-1024-v1-0'
- Pass prompt as array: `[{ text: prompt, weight: 1.0 }]`
- Check results array not empty, extract first result
- Read buffer from filesystem: `await readFile(result.filepath)`
- CRITICAL: Clean up temp file immediately: `await unlink(result.filepath).catch(() => {})` (research pitfall 4)
- Return GenerationResult with buffer, contentType: 'image/png', service: 'Stability'

4. **Error handling with user-actionable messages (research lines 202-228):**
- error.response.status === 401 → "Invalid Stability AI API key. Get your API key from https://platform.stability.ai/account/keys"
- error.response.status === 429 → "Rate limit exceeded. Wait a few moments or upgrade your Stability AI plan."
- error.response.status === 400 → "Your prompt may violate content policy or contain invalid parameters. Try simplifying your prompt."
- All other errors → wrap in AIServiceError with service='Stability'

5. **File cleanup pattern (defensive against SDK leaks):**
```typescript
const buffer = await readFile(result.filepath);

// Clean up SDK's temp file immediately after reading
await unlink(result.filepath).catch(() => {
  // Suppress cleanup errors (file might be in temp dir that OS cleans)
});

return { buffer, contentType: 'image/png', service: 'Stability' };
```

Follow ESM import pattern: use .js extensions for local imports.
  </action>
  <verify>
Run TypeScript compilation:
```bash
npx tsc --noEmit
```

Verify interface implementation:
```bash
grep 'implements AIServiceAdapter' src/services/ai/stability.ts
grep 'generateImage' src/services/ai/stability.ts
grep 'readFile' src/services/ai/stability.ts
grep 'unlink' src/services/ai/stability.ts
```

Check error handling patterns exist:
```bash
grep -c 'AIServiceError' src/services/ai/stability.ts  # Should be 4+ (one per error case)
```
  </verify>
  <done>StabilityService class exists, implements AIServiceAdapter, reads from filepath then cleans up temp file, translates errors to user-friendly messages, compiles without TypeScript errors.</done>
</task>

<task type="auto">
  <name>Register Stability Service in Factory</name>
  <files>src/services/ai/factory.ts</files>
  <action>
Update createAIService factory function to handle 'stability' case, following the OpenAI pattern added in Plan 01.

Add import at top:
```typescript
import { StabilityService } from './stability.js';
```

Add case to switch statement (research lines 282-309):
```typescript
case 'stability':
  // Required API key
  const stabilityKey = apiKey || configService.getApiKey('stability');
  if (!stabilityKey) {
    throw new Error(
      'Stability AI API key required. Set via: zoombg config set stabilityApiKey YOUR_KEY'
    );
  }
  return new StabilityService(stabilityKey);
```

Pattern matches OpenAI case:
- Stability REQUIRES API key (not optional)
- Throw specific error with config command if key missing
- Use ConfigService.getApiKey('stability') to retrieve stored key

Remove placeholder comment "// case 'stability': ..." if it still exists.

After this task, factory supports all three services: huggingface (free), openai (paid), stability (paid).
  </action>
  <verify>
Check factory contains Stability case:
```bash
grep "case 'stability':" src/services/ai/factory.ts
grep "StabilityService" src/services/ai/factory.ts
```

Verify all three services present:
```bash
grep -c "case '" src/services/ai/factory.ts  # Should be 3 (huggingface, openai, stability)
```

Verify TypeScript compiles:
```bash
npx tsc --noEmit
```

Test factory function can instantiate all services:
```bash
node -e "
import { createAIService } from './dist/services/ai/factory.js';
console.log('HuggingFace:', createAIService('huggingface').getServiceName());
console.log('OpenAI (with key):', createAIService('openai', 'test-key').getServiceName());
console.log('Stability (with key):', createAIService('stability', 'test-key').getServiceName());
"
```
  </verify>
  <done>Factory switch contains 'stability' case, validates API key exists before instantiation, returns StabilityService instance, all three services work, compiles without errors.</done>
</task>

<task type="auto">
  <name>Validate Strategy Pattern Architecture</name>
  <files>None (verification only)</files>
  <action>
Verify that adding two new providers required ZERO changes to orchestration layer, validating the Phase 1 Strategy pattern design.

Check that workflow file was NOT modified:
```bash
git diff src/workflows/generate.ts
```

Expected: No changes (workflow still uses `createAIService(service)` - same interface).

Verify all services implement same interface:
```bash
grep 'implements AIServiceAdapter' src/services/ai/*.ts
```

Expected: Three matches (huggingface.ts, openai.ts, stability.ts).

Document in task commit message:
"Validated Strategy pattern: added OpenAI and Stability services with zero orchestration changes, proving service abstraction design from Phase 1."

This validates the architectural decision from Phase 1 Plan 03 (lines 145-158 of 01-03-SUMMARY.md):
- Interface clearly separates contract from implementation ✅
- Factory enables runtime provider selection ✅
- Adding providers requires only new adapter classes + factory case ✅
- Orchestration layer depends on interface not concrete implementations ✅
  </action>
  <verify>
Check workflow was not modified:
```bash
git log --oneline --follow src/workflows/generate.ts | head -1
```

Verify last modification was Phase 2, not Phase 4.

Count service implementations:
```bash
ls src/services/ai/*.ts | wc -l  # Should be 5 (types, factory, huggingface, openai, stability)
```

Check all implement same interface:
```bash
grep -l 'implements AIServiceAdapter' src/services/ai/*.ts | wc -l  # Should be 3
```
  </verify>
  <done>Workflow file unchanged since Phase 2, all three services implement AIServiceAdapter, Strategy pattern validated as zero-orchestration-change architecture.</done>
</task>

</tasks>

<verification>
## Overall Phase Checks

1. **TypeScript compilation:** `npx tsc --noEmit` passes with no errors
2. **All services registered:** Factory switch has huggingface, openai, stability cases
3. **Interface contract:** StabilityService implements all AIServiceAdapter methods
4. **Factory integration:** createAIService('stability', apiKey) returns working adapter
5. **File cleanup:** Stability temp files deleted after buffer extraction (no accumulation)
6. **Architecture validation:** Workflow unchanged since Phase 2 (zero orchestration changes)

## Service Comparison Table

| Service | API Key Required | Timeout | Response Format | Temp Files |
|---------|------------------|---------|-----------------|------------|
| HuggingFace | Optional | 120s | Direct buffer | None |
| OpenAI | Required | 60s | b64_json → buffer | None |
| Stability | Required | 90s | filepath → buffer | Cleaned up |

## Integration Test Pattern

Test all three services instantiate correctly:
```typescript
import { createAIService } from './services/ai/factory.js';

const hf = createAIService('huggingface');
console.log('HuggingFace ready:', hf.getServiceName());

const openai = createAIService('openai', 'sk-test');
console.log('OpenAI ready:', openai.getServiceName());

const stability = createAIService('stability', 'sk-test');
console.log('Stability ready:', stability.getServiceName());
```
</verification>

<success_criteria>
## Measurable Completion

Phase 4 Plan 02 is complete when:

1. ✅ src/services/ai/stability.ts exists with StabilityService class
2. ✅ StabilityService implements AIServiceAdapter interface (all 4 methods)
3. ✅ generateImage uses Stable Diffusion XL with filepath-to-buffer pattern
4. ✅ Temp files cleaned up immediately after buffer extraction (unlink call exists)
5. ✅ Error handling translates 401/429/400 to user-actionable messages
6. ✅ Factory contains 'stability' case with API key validation
7. ✅ Factory supports all three services (huggingface, openai, stability)
8. ✅ TypeScript compilation succeeds with no errors
9. ✅ Workflow file unchanged since Phase 2 (Strategy pattern validated)

**Test with real API key (user action after this plan):**
```bash
# Set API key
node dist/cli.js config set stabilityApiKey sk-YOUR-KEY

# Generate with Stability AI
node dist/cli.js "mountain sunset" --service stability
```

Ready for Plan 03 to add service preference persistence.
</success_criteria>

<output>
After completion, create `.planning/phases/04-multi-service-support/04-02-SUMMARY.md`

SUMMARY.md must include:
- Performance metrics (duration, files created/modified)
- Key decisions (why unlink temp files, error translation patterns)
- Architecture validation (zero orchestration changes proof)
- Deviations from plan (if any)
- Service comparison table (all three providers)
- Next phase readiness for Plan 03 (all services available for persistence logic)
</output>
