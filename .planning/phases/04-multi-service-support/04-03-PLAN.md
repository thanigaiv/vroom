---
phase: 04-multi-service-support
plan: 03
type: execute
wave: 3
depends_on: [04-01, 04-02]
files_modified:
  - src/workflows/generate.ts
  - src/cli.ts
autonomous: true
requirements: [AI-04, CONFIG-03]

must_haves:
  truths:
    - "Tool remembers last used AI service across sessions"
    - "Tool persists service preference to configuration file after successful save"
    - "Tool defaults to last used service when --service flag not provided"
  artifacts:
    - path: "src/workflows/generate.ts"
      provides: "Service persistence after successful save"
      contains: "setLastUsedService"
    - path: "src/cli.ts"
      provides: "Service validation and default logic"
      contains: "getLastUsedService"
  key_links:
    - from: "src/workflows/generate.ts"
      to: "ConfigService.setLastUsedService"
      via: "await configService.setLastUsedService(service)"
      pattern: "setLastUsedService"
    - from: "src/cli.ts"
      to: "ConfigService.getLastUsedService"
      via: "service = configService.getLastUsedService()"
      pattern: "getLastUsedService"
    - from: "src/cli.ts"
      to: "createAIService factory"
      via: "service validation before workflow"
      pattern: "huggingface.*openai.*stability"
---

<objective>
Implement "sticky" service selection by persisting user's AI provider choice to configuration file and defaulting to it on subsequent invocations, completing Phase 4's multi-service support with seamless UX.

Purpose: Eliminates need to repeatedly specify --service flag once user has chosen their preferred provider, making paid services as convenient as free tier for regular use.

Output: Service preference persisted after successful generation, CLI defaults to last used service, all three providers equally accessible.
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-multi-service-support/04-RESEARCH.md
@.planning/phases/04-multi-service-support/04-01-SUMMARY.md
@.planning/phases/04-multi-service-support/04-02-SUMMARY.md
@.planning/phases/03-cli-interface/03-01-SUMMARY.md
@src/workflows/generate.ts
@src/cli.ts
@src/services/config.ts
@src/services/ai/factory.ts
</context>

<tasks>

<task type="auto">
  <name>Persist Service Selection After Successful Save</name>
  <files>src/workflows/generate.ts</files>
  <action>
Modify generateWorkflow function to persist service selection to ConfigService after user approves and saves image (research pattern 3, lines 238-262).

Implementation:

1. **Add ConfigService import at top:**
```typescript
import { ConfigService } from '../services/config.js';
```

2. **Instantiate ConfigService in workflow function:**
```typescript
export async function generateWorkflow(options: WorkflowOptions = {}): Promise<void> {
  const configService = new ConfigService();
  // ... existing code
```

3. **Determine service with fallback chain (research lines 246-251):**

Replace the current hardcoded default:
```typescript
const {
  initialPrompt,
  service = 'huggingface',  // OLD: hardcoded default
  interactive = true
} = options;
```

With fallback chain (CLI flag > lastUsedService > huggingface):
```typescript
const {
  initialPrompt,
  interactive = true
} = options;

// Determine service: CLI flag > lastUsedService > default
let service = options.service;
if (!service) {
  const lastUsed = configService.getLastUsedService();
  service = lastUsed || 'huggingface';
}
```

4. **Persist after successful save (inside approval flow after writeFile):**

Add after line "await writeFile(savePath, result.buffer);":
```typescript
// Persist service preference for next session
await configService.setLastUsedService(service as AIService);
```

CRITICAL timing: Only persist AFTER successful save, not before generation attempt. This prevents persisting failed services.

5. **Type import for AIService:**
```typescript
import type { AIService } from '../types/index.js';
```

Why this placement: User has approved the image, save succeeded, we know the service works. Perfect time to remember their choice.
  </action>
  <verify>
Check workflow contains persistence logic:
```bash
grep 'setLastUsedService' src/workflows/generate.ts
grep 'getLastUsedService' src/workflows/generate.ts
```

Verify ConfigService imported:
```bash
grep "import.*ConfigService" src/workflows/generate.ts
```

Verify fallback chain logic:
```bash
grep -A 3 'getLastUsedService' src/workflows/generate.ts  # Should show fallback to 'huggingface'
```

TypeScript compiles:
```bash
npx tsc --noEmit
```
  </verify>
  <done>Workflow determines service via CLI > lastUsedService > huggingface fallback, persists choice after successful save, ConfigService instantiated and used correctly.</done>
</task>

<task type="auto">
  <name>Update CLI Service Validation and Default Logic</name>
  <files>src/cli.ts</files>
  <action>
Update CLI to validate all three services (huggingface, openai, stability) and pass service selection to workflow correctly.

Current state (from Phase 3): CLI likely validates --service flag and passes to generateWorkflow via options.service.

Required changes:

1. **Update service validation to include all three providers:**

Find the service validation logic (probably near --service flag parsing). Update to:
```typescript
const validServices = ['huggingface', 'openai', 'stability'];
if (service && !validServices.includes(service)) {
  console.error(`Invalid service: ${service}`);
  console.error(`Valid services: ${validServices.join(', ')}`);
  process.exit(1);
}
```

2. **Pass service to workflow options:**

Ensure --service flag value is passed to generateWorkflow:
```typescript
await generateWorkflow({
  initialPrompt: prompt,
  service: options.service,  // CLI flag value (undefined if not provided)
  interactive: true
});
```

When options.service is undefined, the workflow's fallback chain (added in Task 1) will handle defaulting to lastUsedService.

3. **Update help text to reflect all services:**

Find --service flag description in help output, update to:
```typescript
.option('-s, --service <name>', 'AI service to use (huggingface, openai, stability)', 'huggingface')
```

Note: The default value in Commander is descriptive only - actual defaulting happens in workflow via getLastUsedService().

4. **Do NOT pre-load ConfigService in CLI:**

Workflow handles service selection logic. CLI just validates and passes through. This maintains clean separation of concerns.
  </action>
  <verify>
Check CLI validates all three services:
```bash
grep -E '(huggingface|openai|stability)' src/cli.ts | wc -l  # Should be 3+
```

Verify service validation exists:
```bash
grep -i 'valid.*service' src/cli.ts
```

Check help text updated:
```bash
grep -A 1 'service.*option' src/cli.ts  # Should show all three services
```

TypeScript compiles:
```bash
npx tsc --noEmit
```

Test invalid service rejected:
```bash
node dist/cli.js "test" --service invalid 2>&1 | grep -i "invalid service"
```
  </verify>
  <done>CLI validates huggingface, openai, and stability as valid services, passes service flag to workflow options, help text lists all three providers, invalid services rejected with clear error.</done>
</task>

<task type="auto">
  <name>Test Service Persistence End-to-End</name>
  <files>None (verification only)</files>
  <action>
Document the end-to-end service persistence flow and provide test commands for manual verification.

**Flow to document in SUMMARY.md:**

1. **First invocation (no stored preference):**
```bash
node dist/cli.js "mountain sunset"
# Uses huggingface (default)
# After save, persists 'huggingface' to config
```

2. **Second invocation (uses stored preference):**
```bash
node dist/cli.js "ocean waves"
# Uses huggingface (from last session)
# No --service flag needed
```

3. **Override with explicit service:**
```bash
node dist/cli.js "forest scene" --service openai
# Uses openai (CLI flag overrides stored preference)
# After save, persists 'openai' to config
```

4. **Subsequent invocations:**
```bash
node dist/cli.js "desert landscape"
# Uses openai (from last session)
# Sticky preference until user changes via --service flag
```

**Config file inspection (for debugging):**
```bash
node -e "
import { ConfigService } from './dist/services/config.js';
const config = new ConfigService();
console.log('Last used service:', config.getLastUsedService());
console.log('Config file:', config.getConfigPath());
"
```

**Reset preference (manual test):**
```bash
# User can change preference by using --service flag with successful save
node dist/cli.js "new image" --service stability
# Now sticky to stability for future invocations
```

This validates requirements AI-04 (remembers last used service) and CONFIG-03 (persists to config file).
  </action>
  <verify>
Verify ConfigService methods exist:
```bash
grep 'getLastUsedService' src/services/config.ts
grep 'setLastUsedService' src/services/config.ts
```

Check schema includes lastUsedService field:
```bash
grep 'lastUsedService' src/services/config.ts
```

Confirm workflow and CLI both use ConfigService:
```bash
grep -l 'ConfigService' src/workflows/generate.ts src/cli.ts
```

TypeScript compiles:
```bash
npx tsc --noEmit
```
  </verify>
  <done>Service persistence flow documented with test commands, config file location discoverable, all components integrated correctly for sticky service selection.</done>
</task>

</tasks>

<verification>
## Overall Phase Checks

1. **TypeScript compilation:** `npx tsc --noEmit` passes with no errors
2. **Workflow persistence:** setLastUsedService called after successful save
3. **Workflow fallback:** getLastUsedService used when --service not provided
4. **CLI validation:** All three services (huggingface, openai, stability) validated
5. **Integration:** ConfigService used in both workflow and CLI correctly
6. **Timing:** Persistence happens AFTER save, not before (prevents storing failed attempts)

## Service Selection Priority

Documented in code and verified:

```
Priority 1: CLI --service flag (user's explicit choice for this invocation)
Priority 2: ConfigService.getLastUsedService() (user's saved preference)
Priority 3: 'huggingface' (default for first-time users)
```

## Persistence Lifecycle

```
User invokes: node dist/cli.js "prompt" [--service SERVICE]
    ↓
CLI validates service (if provided)
    ↓
Workflow determines service (CLI > lastUsed > default)
    ↓
Generate image with selected service
    ↓
User approves and saves
    ↓
ConfigService.setLastUsedService(service)  ← Persisted here
    ↓
Next invocation defaults to stored service
```

## Manual Test Sequence

1. **Clean slate:** Remove config file if exists
2. **First run:** `node dist/cli.js "test" --service openai` (with valid API key)
3. **Verify saved:** Check config contains lastUsedService: 'openai'
4. **Second run:** `node dist/cli.js "test2"` (no --service flag)
5. **Verify default:** Should use openai from previous session
</verification>

<success_criteria>
## Measurable Completion

Phase 4 Plan 03 is complete when:

1. ✅ Workflow imports and instantiates ConfigService
2. ✅ Service selection uses CLI > lastUsedService > huggingface fallback chain
3. ✅ setLastUsedService called after successful save (not before)
4. ✅ CLI validates all three services: huggingface, openai, stability
5. ✅ CLI help text lists all three services
6. ✅ Invalid service names rejected with clear error message
7. ✅ TypeScript compilation succeeds with no errors
8. ✅ Config file location discoverable via ConfigService.getConfigPath()

**Requirements validation:**
- AI-04 (remembers last used service): ✅ getLastUsedService provides default
- CONFIG-03 (persists to config file): ✅ setLastUsedService writes to conf store

**Architecture validation:**
- Service abstraction complete: All three providers equally accessible
- Zero orchestration changes: Workflow logic unchanged, only configuration layer
- User experience: No repeated --service flags after first choice

**End-to-end test:**
```bash
# First use (sets preference)
node dist/cli.js "mountain" --service openai

# Second use (uses preference)
node dist/cli.js "ocean"  # Should use openai automatically

# Change preference
node dist/cli.js "forest" --service stability  # Now sticky to stability
```

Phase 4 complete - multi-service support with persistent preferences working.
</success_criteria>

<output>
After completion, create `.planning/phases/04-multi-service-support/04-03-SUMMARY.md`

SUMMARY.md must include:
- Performance metrics (duration, files modified)
- Key decisions (when to persist, fallback chain order, why after save not before)
- Service selection flow diagram
- Manual test results (all three services work with persistence)
- Deviations from plan (if any)
- Phase 4 completion status (all requirements met)
- Phase 5 readiness (dry-run mode can now work with any service)
</output>
