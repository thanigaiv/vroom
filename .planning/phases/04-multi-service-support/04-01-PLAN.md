---
phase: 04-multi-service-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/services/ai/openai.ts
  - src/services/ai/factory.ts
autonomous: true
requirements: [AI-02]

must_haves:
  truths:
    - "User can generate images using OpenAI DALL-E 3 when API key is configured"
    - "Tool validates OpenAI API key exists before attempting generation"
    - "OpenAI errors provide actionable messages with API key setup URLs"
  artifacts:
    - path: "src/services/ai/openai.ts"
      provides: "OpenAI DALL-E 3 service adapter"
      exports: ["OpenAIService"]
      min_lines: 100
    - path: "src/services/ai/factory.ts"
      provides: "OpenAI case in factory switch"
      contains: "case 'openai':"
    - path: "package.json"
      provides: "openai SDK dependency"
      contains: "\"openai\""
  key_links:
    - from: "src/services/ai/openai.ts"
      to: "openai SDK"
      via: "import OpenAI from 'openai'"
      pattern: "import.*openai"
    - from: "src/services/ai/factory.ts"
      to: "src/services/ai/openai.ts"
      via: "case 'openai': return new OpenAIService"
      pattern: "case 'openai'"
    - from: "src/services/ai/openai.ts"
      to: "AIServiceAdapter interface"
      via: "implements AIServiceAdapter"
      pattern: "implements AIServiceAdapter"
---

<objective>
Add OpenAI DALL-E 3 as a paid AI provider option, implementing the established Strategy pattern to enable high-quality image generation for users willing to provide API keys.

Purpose: Validates the Phase 1 service abstraction by adding a second provider with zero orchestration changes, and provides quality upgrade path for users beyond free tier limitations.

Output: OpenAI service adapter integrated into factory, ready for user selection via --service openai flag.
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-multi-service-support/04-RESEARCH.md
@.planning/phases/01-foundation-and-core-services/01-01-SUMMARY.md
@.planning/phases/01-foundation-and-core-services/01-03-SUMMARY.md
@src/services/ai/types.ts
@src/services/ai/factory.ts
@src/services/ai/huggingface.ts
@src/services/config.ts
@src/services/errors.ts
</context>

<tasks>

<task type="auto">
  <name>Install AI Provider SDKs</name>
  <files>package.json</files>
  <action>
Install official OpenAI SDK and community Stability AI SDK (installing both now for efficiency, Stability used in Plan 02):

```bash
npm install openai@6.22.0 stability-ai@0.7.0
```

Versions confirmed in RESEARCH.md (lines 31-38):
- openai@6.22.0: Official SDK with TypeScript support, automatic retries, comprehensive error types
- stability-ai@0.7.0: Most maintained community SDK (updated Nov 2024), TypeScript support

Both SDKs are production-ready and provide the interface patterns documented in Phase 4 research.
  </action>
  <verify>
Check package.json contains both dependencies:
```bash
grep '"openai":' package.json && grep '"stability-ai":' package.json
```

Verify installation succeeded:
```bash
npm list openai stability-ai
```
  </verify>
  <done>Both openai@6.22.0 and stability-ai@0.7.0 appear in package.json dependencies and node_modules.</done>
</task>

<task type="auto">
  <name>Create OpenAI DALL-E 3 Service Adapter</name>
  <files>src/services/ai/openai.ts</files>
  <action>
Create OpenAIService implementing AIServiceAdapter interface, following the established HuggingFaceService pattern from Phase 1.

Implementation requirements (from RESEARCH.md lines 69-144):

1. **Import and constructor:**
```typescript
import OpenAI from 'openai';
import type { AIServiceAdapter, GenerationResult } from './types.js';
import { AIServiceError } from '../errors.js';

export class OpenAIService implements AIServiceAdapter {
  private client: OpenAI;

  constructor(apiKey: string) {
    this.client = new OpenAI({ apiKey });
  }
```

2. **Interface methods:**
- getServiceName(): return 'OpenAI'
- requiresApiKey(): return true (DALL-E requires API key)
- getTimeout(): return 60000 (60 seconds - faster than Hugging Face)

3. **generateImage implementation:**
- Use `client.images.generate()` with model='dall-e-3'
- Set response_format: 'b64_json' to get base64 data (NOT URL - avoids CORS, matches research pitfall 3 lines 351-358)
- Set size: '1024x1024' (standard square format for Zoom backgrounds)
- Set n: 1 (DALL-E 3 only supports single image)
- Extract imageData.b64_json and convert to Buffer: `Buffer.from(imageData.b64_json, 'base64')`
- Return GenerationResult with buffer, contentType: 'image/png', service: 'OpenAI'

4. **Error handling with user-actionable messages (research lines 116-143):**
- 401 error → "Invalid OpenAI API key. Get your API key from https://platform.openai.com/api-keys"
- 429 error → "Rate limit exceeded. Wait a few moments or check your OpenAI billing at https://platform.openai.com/account/billing"
- 400 with 'content_policy' → "Your prompt violates OpenAI content policy. Try rephrasing to avoid explicit or harmful content."
- All other errors → wrap in AIServiceError with service='OpenAI'

Follow ESM import pattern: use .js extensions for local imports (established in Phase 1).
  </action>
  <verify>
Run TypeScript compilation:
```bash
npx tsc --noEmit
```

Verify interface implementation:
```bash
grep 'implements AIServiceAdapter' src/services/ai/openai.ts
grep 'generateImage' src/services/ai/openai.ts
grep 'getServiceName' src/services/ai/openai.ts
```

Check error handling patterns exist:
```bash
grep -c 'AIServiceError' src/services/ai/openai.ts  # Should be 4+ (one per error case)
```
  </verify>
  <done>OpenAIService class exists, implements AIServiceAdapter, uses b64_json response format, translates errors to user-friendly messages, compiles without TypeScript errors.</done>
</task>

<task type="auto">
  <name>Register OpenAI Service in Factory</name>
  <files>src/services/ai/factory.ts</files>
  <action>
Update createAIService factory function to handle 'openai' case, following existing 'huggingface' pattern.

Add import at top:
```typescript
import { OpenAIService } from './openai.js';
```

Add case to switch statement (research lines 282-309):
```typescript
case 'openai':
  // Required API key
  const openaiKey = apiKey || configService.getApiKey('openai');
  if (!openaiKey) {
    throw new Error(
      'OpenAI API key required. Set via: zoombg config set openaiApiKey YOUR_KEY'
    );
  }
  return new OpenAIService(openaiKey);
```

Key differences from HuggingFace:
- OpenAI REQUIRES API key (not optional like HuggingFace free tier)
- Throw specific error with config command if key missing
- Use ConfigService.getApiKey('openai') to retrieve stored key

Import ConfigService if not already imported (should exist from existing HuggingFace case).

Remove placeholder comment "// Phase 4: Add DALL-E and Stability AI cases here" since we're implementing it.
  </action>
  <verify>
Check factory contains OpenAI case:
```bash
grep "case 'openai':" src/services/ai/factory.ts
grep "OpenAIService" src/services/ai/factory.ts
```

Verify TypeScript compiles:
```bash
npx tsc --noEmit
```

Test factory function can be imported:
```bash
node -e "import('./dist/services/ai/factory.js').then(m => console.log('Factory loads:', typeof m.createAIService))"
```
  </verify>
  <done>Factory switch contains 'openai' case, validates API key exists before instantiation, returns OpenAIService instance, compiles without errors.</done>
</task>

</tasks>

<verification>
## Overall Phase Checks

1. **TypeScript compilation:** `npx tsc --noEmit` passes with no errors
2. **Dependencies installed:** Both openai and stability-ai appear in node_modules
3. **Interface contract:** OpenAIService implements all AIServiceAdapter methods
4. **Factory integration:** createAIService('openai', apiKey) returns working adapter
5. **Error handling:** User-friendly messages for 401, 429, 400 errors with actionable URLs

## Integration Test Pattern

Test that OpenAI service integrates with existing workflow (manual test for Plan 03):
```typescript
import { createAIService } from './services/ai/factory.js';

const service = createAIService('openai', 'sk-test-key');
console.log('Service name:', service.getServiceName());
console.log('Requires API key:', service.requiresApiKey());
console.log('Timeout:', service.getTimeout());
```

Expected output:
- Service name: OpenAI
- Requires API key: true
- Timeout: 60000
</verification>

<success_criteria>
## Measurable Completion

Phase 4 Plan 01 is complete when:

1. ✅ openai@6.22.0 SDK installed and listed in package.json
2. ✅ src/services/ai/openai.ts exists with OpenAIService class
3. ✅ OpenAIService implements AIServiceAdapter interface (all 4 methods)
4. ✅ generateImage uses DALL-E 3 with b64_json response format
5. ✅ Error handling translates 401/429/400 to user-actionable messages
6. ✅ Factory contains 'openai' case with API key validation
7. ✅ TypeScript compilation succeeds with no errors
8. ✅ createAIService('openai', apiKey) returns working OpenAIService instance

**Test with real API key (user action after this plan):**
```bash
# Set API key
node dist/cli.js config set openaiApiKey sk-YOUR-KEY

# Generate with OpenAI (Phase 3 CLI already supports --service flag)
node dist/cli.js "mountain sunset" --service openai
```

This will be fully functional after Plan 03 adds service preference persistence.
</success_criteria>

<output>
After completion, create `.planning/phases/04-multi-service-support/04-01-SUMMARY.md`

SUMMARY.md must include:
- Performance metrics (duration, files created/modified)
- Key decisions (why b64_json not URL, error translation patterns)
- Deviations from plan (if any)
- Integration readiness for Plan 02 (Stability AI can follow same pattern)
- Next phase readiness for Plan 03 (service preference persistence)
</output>
