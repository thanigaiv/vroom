---
phase: 05-enhancement-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli.ts
  - src/workflows/generate.ts
autonomous: true
requirements: [CONFIG-04]

must_haves:
  truths:
    - User can run tool with --dry-run flag to test without saving
    - Tool shows clear "would save to [path]" message in dry-run mode
    - Tool does not create files in Zoom directory during dry-run
    - Tool does not persist service preference during dry-run
  artifacts:
    - path: src/cli.ts
      provides: --dry-run flag parsing
      min_lines: 115
      contains: "--dry-run"
    - path: src/workflows/generate.ts
      provides: Conditional persistence logic
      min_lines: 180
      contains: "dryRun"
  key_links:
    - from: src/cli.ts
      to: src/workflows/generate.ts
      via: dryRun option
      pattern: "dryRun.*options\\.dryRun"
    - from: src/workflows/generate.ts
      to: writeFile skip
      via: conditional check
      pattern: "if.*dryRun.*else.*writeFile"
---

<objective>
Add dry-run mode that simulates workflow without saving to Zoom directory.

Purpose: Enable users to test tool functionality, validate API keys, and preview images without modifying their Zoom backgrounds directory. Reduces risk for first-time users and enables CI/CD testing.

Output: Working --dry-run flag that generates and previews images but skips persistence with clear feedback messages.
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/tvellore/work/.planning/PROJECT.md
@/Users/tvellore/work/.planning/ROADMAP.md
@/Users/tvellore/work/.planning/STATE.md
@/Users/tvellore/work/.planning/REQUIREMENTS.md
@/Users/tvellore/work/.planning/phases/05-enhancement-polish/05-RESEARCH.md

# Existing implementation
@/Users/tvellore/work/src/cli.ts
@/Users/tvellore/work/src/workflows/generate.ts

# Error handling pattern
@/Users/tvellore/work/src/services/errors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --dry-run flag to CLI</name>
  <files>src/cli.ts</files>
  <action>
Add --dry-run boolean option to Commander configuration in src/cli.ts.

Add after the existing --service option (around line 36):
```typescript
.option('--dry-run', 'simulate operation without saving to Zoom')
```

Pass dryRun option to generateWorkflow call (around line 68):
```typescript
await generateWorkflow({
  initialPrompt: prompt,
  service: options.service,
  interactive: true,
  dryRun: options.dryRun  // NEW: pass through to workflow
});
```

Update help text examples section (around line 46) to include dry-run example:
```typescript
  Test without saving:
    $ zoombg "ocean waves" --dry-run
```

Implementation notes:
- Commander automatically converts --dry-run to options.dryRun (camelCase)
- Keep boolean flag simple (no argument, presence = true)
- Research reference: RESEARCH.md lines 73-81 (Commander boolean flags)
  </action>
  <verify>
Run: npm run build && node dist/cli.js --help | grep -A1 "dry-run"
Should show: "--dry-run" in options list

Run: node dist/cli.js "test" --dry-run --service huggingface
Should not throw parsing errors (may fail at generation if no API key - expected)
  </verify>
  <done>
- --dry-run appears in help text
- CLI accepts --dry-run flag without errors
- options.dryRun is passed to generateWorkflow
- Help text includes dry-run example
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement conditional persistence in workflow</name>
  <files>src/workflows/generate.ts</files>
  <action>
Update WorkflowOptions interface to include dryRun option (around line 28):
```typescript
export interface WorkflowOptions {
  initialPrompt?: string;
  service?: string;
  interactive?: boolean;
  dryRun?: boolean;  // NEW
}
```

Extract dryRun from options (around line 66):
```typescript
const {
  initialPrompt,
  interactive = true,
  dryRun = false  // NEW: default to false for normal operation
} = options;
```

Replace save block (lines 142-158) with conditional logic:
```typescript
if (dryRun) {
  // Dry-run mode: show what would happen without saving
  const bgManager = new BackgroundManager();
  const bgDir = await bgManager.findBackgroundsDirectory();
  const filename = `zoombg-${Date.now()}.png`;
  const savePath = join(bgDir, filename);

  console.log(pc.cyan('\n[DRY-RUN] Simulation mode - no files saved'));
  console.log(pc.dim(`  Would save to: ${savePath}`));
  console.log(pc.dim(`  Image size: ${result.buffer.length} bytes`));
  console.log(pc.dim(`  Service: ${service}`));
  console.log(pc.dim(`  Would persist service preference: ${service}`));
} else {
  // Normal mode: actually save
  const saveSpinner = ora('Saving to Zoom backgrounds...').start();

  const bgManager = new BackgroundManager();
  const bgDir = await bgManager.findBackgroundsDirectory();
  const filename = `zoombg-${Date.now()}.png`;
  const savePath = join(bgDir, filename);

  await writeFile(savePath, result.buffer);
  await configService.setLastUsedService(service as AIService);

  saveSpinner.succeed(`Saved as ${filename}`);
  console.log(`\nZoom background saved to: ${savePath}`);
}
```

Import picocolors at top of file (around line 16):
```typescript
import pc from 'picocolors';
```

Critical requirements:
- Dry-run MUST NOT call writeFile() - never create files in Zoom directory
- Dry-run MUST NOT call setLastUsedService() - never persist config changes
- Dry-run MUST show full path so user knows where file would be saved
- Dry-run message must be visually distinct (cyan color, [DRY-RUN] prefix)
- Normal mode behavior unchanged (spinner, success message, actual file write)

Research references:
- RESEARCH.md lines 68-118 (Pattern 1: Dry-run with conditional persistence)
- RESEARCH.md lines 336-343 (Pitfall 1: Dry-run mode still persists data)
  </action>
  <verify>
Build and test dry-run mode:
```bash
npm run build
node dist/cli.js "test image" --dry-run --service huggingface
```

Expected output:
- "[DRY-RUN] Simulation mode" message appears
- "Would save to: [path]" shows Zoom backgrounds directory path
- Image size and service displayed
- No actual file created in Zoom directory

Verify normal mode still works:
```bash
node dist/cli.js "test image" --service huggingface
```

Expected output:
- No [DRY-RUN] messages
- Spinner shows "Saving to Zoom backgrounds..."
- File actually created in Zoom directory (if Zoom installed)

Check for regressions:
- TypeScript compiles: npx tsc --noEmit
- All imports resolve correctly
  </verify>
  <done>
- WorkflowOptions includes dryRun boolean field
- Dry-run mode shows [DRY-RUN] message with cyan color
- Dry-run shows "would save to" path, size, service info
- Dry-run does NOT call writeFile or setLastUsedService
- Normal mode behavior unchanged
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Update help documentation</name>
  <files>src/cli.ts</files>
  <action>
Enhance the addHelpText section (around lines 36-49) to clarify dry-run behavior.

Update to:
```typescript
.addHelpText('after', `

Examples:
  Generate interactively:
    $ zoombg

  Generate with prompt:
    $ zoombg "serene mountain landscape at sunset"

  Use specific AI service:
    $ zoombg "modern office" --service openai

  Test without saving (dry-run):
    $ zoombg "ocean waves" --dry-run
    (Generates and previews image, but doesn't save to Zoom)

Dry-Run Mode:
  The --dry-run flag simulates the complete workflow without:
  - Saving files to Zoom backgrounds directory
  - Persisting service preference to config
  Use this to test API keys, preview images, or validate prompts.

Documentation: https://github.com/user/zoombg
`)
```

Add informational note at start of dry-run execution (in action handler, around line 68):
```typescript
if (options.dryRun) {
  console.log(pc.yellow('Running in dry-run mode - no changes will be saved\n'));
}
```

This provides upfront feedback that dry-run is active before workflow starts.

Research reference: RESEARCH.md lines 295-310 (verbose logging and user feedback)
  </action>
  <verify>
View updated help text:
```bash
node dist/cli.js --help
```

Check output contains:
- "Test without saving (dry-run)" example
- "Dry-Run Mode:" section explaining what is skipped
- Clear explanation of use cases

Run dry-run and verify upfront message:
```bash
node dist/cli.js "test" --dry-run
```

Should show: "Running in dry-run mode" message before workflow starts
  </verify>
  <done>
- Help text includes dry-run example
- Help text explains what dry-run skips
- Dry-run execution shows upfront warning message
- Documentation is clear about dry-run behavior
  </done>
</task>

</tasks>

<verification>
## Manual Testing

Test dry-run mode:
```bash
# Build
npm run build

# Dry-run with prompt
node dist/cli.js "serene lake at sunrise" --dry-run

# Expected flow:
# 1. Shows "Running in dry-run mode" message
# 2. Prompts for approval (or takes initial prompt)
# 3. Generates image (real AI call)
# 4. Opens browser preview
# 5. User approves
# 6. Shows [DRY-RUN] message with path/size/service
# 7. Does NOT create file in Zoom directory
```

Test normal mode still works:
```bash
node dist/cli.js "mountain sunset" --service huggingface

# Expected flow:
# 1. No dry-run message
# 2. Generates and previews
# 3. User approves
# 4. Actually saves to Zoom directory
# 5. Shows success message with filename
```

Verify file creation:
```bash
# After dry-run: count files
ls ~/Library/Application\ Support/zoom.us/data/VirtualBkgnd_Custom/ | wc -l

# Run normal mode
node dist/cli.js "test" --service huggingface

# After normal mode: count should increase by 1
ls ~/Library/Application\ Support/zoom.us/data/VirtualBkgnd_Custom/ | wc -l
```

## Automated Checks

```bash
# TypeScript compilation
npx tsc --noEmit

# Help text validation
node dist/cli.js --help | grep "dry-run"

# CLI flag parsing
node dist/cli.js "test" --dry-run --help
```
</verification>

<success_criteria>
1. User can run `zoombg "prompt" --dry-run` without errors
2. Dry-run mode generates and previews image (real AI call)
3. Dry-run mode shows [DRY-RUN] message with full save path
4. Dry-run mode does NOT create files in Zoom directory
5. Dry-run mode does NOT persist service preference to config
6. Normal mode (without --dry-run) behavior is unchanged
7. Help text clearly explains dry-run functionality
8. TypeScript compiles without errors
9. CONFIG-04 requirement fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/05-enhancement-polish/05-01-SUMMARY.md`
</output>
