---
phase: 01-foundation-and-core-services
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/ai/types.ts
  - src/services/ai/huggingface.ts
  - src/services/ai/factory.ts
  - src/utils/fs-utils.ts
autonomous: true
requirements: [AI-01]

must_haves:
  truths:
    - "Tool generates images using Hugging Face without API key"
    - "Generated image is returned as Buffer for saving"
    - "AI service errors are wrapped with user-friendly messages"
  artifacts:
    - path: "src/services/ai/types.ts"
      provides: "AI service interface definition"
      exports: ["AIServiceAdapter", "GenerationRequest", "GenerationResult"]
      min_lines: 20
    - path: "src/services/ai/huggingface.ts"
      provides: "Hugging Face service implementation"
      exports: ["HuggingFaceService"]
      min_lines: 40
    - path: "src/services/ai/factory.ts"
      provides: "AI service factory for provider selection"
      exports: ["createAIService"]
      min_lines: 20
    - path: "src/utils/fs-utils.ts"
      provides: "Atomic file write utilities"
      exports: ["atomicWriteFile"]
      min_lines: 30
  key_links:
    - from: "src/services/ai/huggingface.ts"
      to: "@huggingface/inference"
      via: "InferenceClient for text-to-image"
      pattern: "InferenceClient.*textToImage"
    - from: "src/services/ai/huggingface.ts"
      to: "src/services/errors.ts"
      via: "AIServiceError for API failures"
      pattern: "throw new AIServiceError"
    - from: "src/services/ai/factory.ts"
      to: "src/services/ai/huggingface.ts"
      via: "instantiates HuggingFaceService"
      pattern: "new HuggingFaceService"
---

<objective>
Implement AI service abstraction with Hugging Face free tier as first provider. Establish service adapter pattern that enables adding DALL-E and Stability AI in Phase 4 without changing orchestration code.

Purpose: Provides working image generation capability using free tier (no API key required). Service abstraction pattern validates architecture early - if adding providers later is difficult, we know Phase 1 architecture needs revision.

Output: Working Hugging Face integration with service adapter pattern ready for multi-provider support.
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/tvellore/work/.planning/PROJECT.md
@/Users/tvellore/work/.planning/ROADMAP.md
@/Users/tvellore/work/.planning/STATE.md
@/Users/tvellore/work/.planning/phases/01-foundation-and-core-services/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Create AI service adapter interface</name>
  <files>src/services/ai/types.ts</files>
  <action>
    Define TypeScript interfaces for AI service abstraction:

    1. Define GenerationRequest interface:
       - prompt: string (user's text description)
       - service?: string (optional service override)
    2. Define GenerationResult interface:
       - buffer: Buffer (image data ready to write)
       - contentType: string (MIME type like 'image/png')
       - service: string (which service generated this)
    3. Define AIServiceAdapter interface (Strategy pattern):
       - generateImage(prompt: string): Promise<GenerationResult>
       - getServiceName(): string
       - requiresApiKey(): boolean
       - getTimeout(): number (service-specific timeout in milliseconds)
    4. Export all interfaces

    WHY STRATEGY PATTERN: Enables adding DALL-E and Stability AI in Phase 4 by implementing same interface. Orchestrator (Phase 2) depends on interface not implementation, so adding providers requires zero orchestration changes.

    Reference pattern from RESEARCH.md Pattern 1 (lines 84-125).
  </action>
  <verify>
    - src/services/ai/types.ts exports GenerationRequest, GenerationResult, AIServiceAdapter interfaces
    - AIServiceAdapter includes generateImage, getServiceName, requiresApiKey, getTimeout methods
    - File compiles without TypeScript errors
  </verify>
  <done>
    AI service interfaces exist defining contract for all providers.
  </done>
</task>

<task type="auto">
  <name>Implement Hugging Face service with error wrapping</name>
  <files>src/services/ai/huggingface.ts</files>
  <action>
    Create HuggingFaceService class implementing AIServiceAdapter:

    1. Import InferenceClient from '@huggingface/inference'
    2. Import AIServiceAdapter, GenerationResult from './types.js'
    3. Import AIServiceError from '../errors.js'
    4. Implement HuggingFaceService class:
       - Private property client: InferenceClient
       - Constructor accepts optional apiKey: string | undefined
         Initialize client as new InferenceClient(apiKey || undefined) - undefined enables free tier
       - getServiceName(): returns 'HuggingFace'
       - requiresApiKey(): returns false (free tier works without key)
       - getTimeout(): returns 120000 (120 seconds for free tier, per RESEARCH.md conservative timeout)
       - generateImage(prompt: string): async method
         a. Wrap in try/catch for error translation
         b. Call this.client.textToImage({ model: 'black-forest-labs/FLUX.1-schnell', inputs: prompt })
         c. Convert Blob to Buffer: Buffer.from(await blob.arrayBuffer())
         d. Return GenerationResult: { buffer, contentType: 'image/png', service: 'HuggingFace' }
         e. In catch block: Check error message for specific failures:
            - '429' in message: throw AIServiceError with "Rate limit reached. Wait 60 seconds and try again, or provide an API key for higher limits."
            - '400' in message: throw AIServiceError with "Your prompt may violate content policy. Try rephrasing to avoid explicit, violent, or copyrighted content."
            - Default: throw AIServiceError with generic message
    5. Export HuggingFaceService as default export

    MODEL CHOICE: FLUX.1-schnell is fast free model per RESEARCH.md (line 112). Do not use stable-diffusion models as they may not be available on free tier.

    Reference patterns from RESEARCH.md Pattern 3 (error wrapping, lines 186-233) and Hugging Face Free Tier example (lines 505-522).
  </action>
  <verify>
    - src/services/ai/huggingface.ts exports HuggingFaceService implementing AIServiceAdapter
    - generateImage method wraps API calls in try/catch with AIServiceError translation
    - Constructor accepts undefined for free tier mode
    - Uses model 'black-forest-labs/FLUX.1-schnell'
    - File compiles without TypeScript errors
  </verify>
  <done>
    HuggingFaceService exists with free tier support, error wrapping, and returns image as Buffer.
  </done>
</task>

<task type="auto">
  <name>Create AI service factory and atomic file utilities</name>
  <files>src/services/ai/factory.ts, src/utils/fs-utils.ts</files>
  <action>
    Create factory for AI service instantiation and atomic file writing utility:

    1. In src/services/ai/factory.ts:
       - Import AIServiceAdapter from './types.js'
       - Import HuggingFaceService from './huggingface.js'
       - Import AIService type from '../../types/index.js'
       - Implement createAIService(service: AIService, apiKey?: string): AIServiceAdapter
         Switch on service parameter:
         - Case 'huggingface': return new HuggingFaceService(apiKey)
         - Default: throw Error(`Unsupported AI service: ${service}`)
       - Export createAIService function

    2. In src/utils/fs-utils.ts:
       - Import writeFile, rename, unlink from 'node:fs/promises'
       - Import join, dirname from 'node:path'
       - Import randomBytes from 'node:crypto'
       - Implement atomicWriteFile(filePath: string, data: string | Buffer, mode: number = 0o644): Promise<void>
         a. Generate temp path: join(dirname(filePath), `.${randomBytes(8).toString('hex')}.tmp`)
         b. Write data to temp path with mode permissions: writeFile(tempPath, data, { mode })
         c. Atomically rename temp to final: rename(tempPath, filePath)
         d. Wrap in try/catch: on error, attempt unlink(tempPath) in nested try/catch (ignore cleanup errors)
       - Export atomicWriteFile

    WHY ATOMIC WRITE: Prevents corruption if process crashes during write. POSIX guarantees rename() is atomic. Used for saving images to Zoom directory in Phase 2 per RESEARCH.md Pattern 5 (lines 289-326).

    WHY FACTORY: Centralizes service instantiation logic. Phase 4 adds 'openai' and 'stability' cases here without changing any other code.
  </action>
  <verify>
    - src/services/ai/factory.ts exports createAIService function
    - createAIService returns HuggingFaceService for 'huggingface' parameter
    - src/utils/fs-utils.ts exports atomicWriteFile function
    - atomicWriteFile uses temp file + rename pattern
    - Both files compile without TypeScript errors
  </verify>
  <done>
    AI service factory exists for provider selection, atomic file writer exists for safe image saves.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Run `tsc --noEmit` to verify TypeScript compilation
2. Check that HuggingFaceService constructor accepts undefined for free tier
3. Check that generateImage wraps textToImage call in try/catch with AIServiceError
4. Verify atomicWriteFile uses temp file + rename pattern (not direct write)
5. Confirm factory.ts imports HuggingFaceService and returns it for 'huggingface' case
</verification>

<success_criteria>
- [ ] AIServiceAdapter interface defines contract for all providers
- [ ] HuggingFaceService implements interface with free tier support (no API key)
- [ ] generateImage returns Buffer ready for file writing
- [ ] AI errors wrapped with user-friendly messages (rate limits, content policy)
- [ ] createAIService factory function instantiates correct service
- [ ] atomicWriteFile prevents corruption with temp-then-rename pattern
- [ ] All files compile with `tsc --noEmit`
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-core-services/01-03-SUMMARY.md`
</output>
