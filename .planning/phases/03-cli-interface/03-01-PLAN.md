---
phase: 03-cli-interface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/cli.ts
  - src/workflows/generate.ts
autonomous: true
requirements: [CONFIG-02]

must_haves:
  truths:
    - "User can invoke tool with text prompt via command-line argument"
    - "User can select AI service using --service flag"
    - "Tool displays help documentation when user runs --help"
    - "Tool shows version information when user runs --version"
  artifacts:
    - path: "src/cli.ts"
      provides: "CLI entry point with commander configuration"
      min_lines: 80
      exports: ["main"]
    - path: "package.json"
      provides: "bin field configuration"
      contains: '"bin":'
    - path: "src/workflows/generate.ts"
      provides: "Modified workflow accepting options"
      exports: ["generateWorkflow", "WorkflowOptions"]
  key_links:
    - from: "src/cli.ts"
      to: "src/workflows/generate.js"
      via: "import statement"
      pattern: "import.*generateWorkflow.*from.*workflows/generate"
    - from: "package.json"
      to: "dist/cli.js"
      via: "bin field"
      pattern: '"zoombg".*"./dist/cli.js"'
    - from: "src/cli.ts"
      to: "generateWorkflow"
      via: "function call with options"
      pattern: "generateWorkflow\\(\\{[^}]*service"
---

<objective>
Create command-line interface that wraps Phase 2 workflow orchestrator, enabling users to invoke the tool with text prompts and select AI services via command-line arguments.

Purpose: Make the tool usable from terminal by parsing arguments, validating inputs, displaying help documentation, and providing user-friendly error messages.

Output: Executable CLI tool installable via npm with `zoombg` command supporting `--service` flag and help documentation.
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-cli-interface/03-RESEARCH.md
@.planning/phases/02-workflow-orchestration/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install CLI Dependencies</name>
  <files>package.json</files>
  <action>
Install Commander v14.0.3 and picocolors v1.1.1 for CLI argument parsing and terminal styling:

```bash
npm install commander@^14.0.3 picocolors@^1.1.1
```

**Why these versions:**
- Commander v14.0.3: Latest stable with TypeScript support and 12-month support window (per research). DO NOT use v15 (ESM-only, requires Node 22.12+).
- picocolors v1.1.1: 14x smaller than chalk, dual ESM/CommonJS support (per research lines 38-40).

Verify installation adds both to package.json dependencies (not devDependencies).
  </action>
  <verify>
Run `npm list commander picocolors` and confirm both packages installed at specified versions.
  </verify>
  <done>
package.json contains "commander": "^14.0.3" and "picocolors": "^1.1.1" in dependencies section.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CLI Entry Point</name>
  <files>src/cli.ts, src/workflows/generate.ts</files>
  <action>
**Part A: Modify workflow for CLI integration**

Update `src/workflows/generate.ts` to accept optional parameters:

1. Export new `WorkflowOptions` interface:
```typescript
export interface WorkflowOptions {
  initialPrompt?: string;
  service?: string;
  interactive?: boolean;
}
```

2. Update `generateWorkflow` signature:
```typescript
export async function generateWorkflow(options: WorkflowOptions = {}): Promise<void>
```

3. Destructure options with defaults:
```typescript
const {
  initialPrompt,
  service = 'huggingface',
  interactive = true
} = options;
```

4. Modify workflow to:
   - Use `service` parameter when calling `createAIService(service as any)` (replacing hardcoded 'huggingface')
   - Use `initialPrompt` if provided, otherwise prompt user if interactive
   - In non-interactive mode, require initialPrompt or throw error

Keep existing logic intact - only parameterize service selection and initial prompt.

**Part B: Create CLI entry point**

Create `src/cli.ts` following research pattern (lines 562-730):

```typescript
#!/usr/bin/env node

import { Command } from 'commander';
import { fileURLToPath } from 'node:url';
import { resolve, dirname, join } from 'node:path';
import { readFile } from 'node:fs/promises';
import pc from 'picocolors';
import { generateWorkflow } from './workflows/generate.js';
import { ZoomBGError } from './services/errors.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

async function getVersion(): Promise<string> {
  const packageJson = await readFile(
    join(__dirname, '../package.json'),
    'utf-8'
  );
  return JSON.parse(packageJson).version;
}

async function main() {
  const version = await getVersion();
  const program = new Command();

  program
    .name('zoombg')
    .version(version)
    .description('Generate AI-powered Zoom backgrounds from text prompts')
    .argument('[prompt]', 'Description of the background to generate')
    .option(
      '-s, --service <name>',
      'AI service (huggingface, openai, stability)',
      'huggingface'
    )
    .addHelpText('after', `

Examples:
  Generate interactively:
    $ zoombg

  Generate with prompt:
    $ zoombg "serene mountain landscape at sunset"

  Use specific AI service:
    $ zoombg "modern office" --service openai

Documentation: https://github.com/user/zoombg
    `)
    .action(async (prompt, options) => {
      try {
        // Validate service (research lines 624-638)
        const validServices = ['huggingface', 'openai', 'stability'];
        if (!validServices.includes(options.service)) {
          console.error(
            pc.red('Error:'),
            `Invalid service "${options.service}"`
          );
          console.error(
            pc.yellow('Valid services:'),
            validServices.join(', ')
          );
          process.exitCode = 1;
          return;
        }

        // Invoke workflow
        await generateWorkflow({
          initialPrompt: prompt,
          service: options.service,
          interactive: true  // Phase 3 only supports interactive mode
        });

        process.exitCode = 0;
      } catch (error) {
        handleError(error);
      }
    });

  try {
    await program.parseAsync(process.argv);
  } catch (error) {
    handleError(error);
  }
}

function handleError(error: Error | unknown): void {
  if (error instanceof ZoomBGError) {
    console.error(pc.red('Error:'), error.message);
    console.error(pc.yellow('Solution:'), error.userMessage);
    process.exitCode = 1;
  } else if (error instanceof Error) {
    console.error(pc.red('Error:'), error.message);

    // Provide context for common errors (research lines 695-699)
    if (error.message.includes('ENOENT')) {
      console.error(pc.yellow('Suggestion:'), 'Check that all required files exist');
    } else if (error.message.includes('EACCES')) {
      console.error(pc.yellow('Suggestion:'), 'Check file permissions');
    }

    process.exitCode = 1;
  } else {
    console.error(pc.red('Unexpected error:'), error);
    process.exitCode = 1;
  }
}

// Only run if this is the entry point (research lines 717-720)
const argv1 = resolve(process.argv[1]);
if (__filename === argv1) {
  main().catch((error) => {
    console.error(pc.red('Fatal error:'), error);
    process.exit(1);
  });
}

export { main };
```

**Key patterns from research:**
- Shebang at line 1 for executable (research lines 439-450)
- Service validation before workflow invocation (research lines 527-555)
- Error handling with picocolors styling (research lines 684-715)
- Entry point detection to support testing (research lines 717-726)

**DO NOT add non-interactive mode support yet** - Phase 3 scope is basic CLI wrapping. Leave `interactive: true` hardcoded.
  </action>
  <verify>
1. Run `npx tsc --noEmit` - should compile without errors
2. Run `npm run build` - should build successfully
3. Check `dist/cli.js` starts with `#!/usr/bin/env node`
4. Run `node dist/cli.js --help` - should display help text
5. Run `node dist/cli.js --version` - should display version
  </verify>
  <done>
- src/cli.ts exists with shebang, commander configuration, and error handling
- src/workflows/generate.ts exports WorkflowOptions interface and accepts options parameter
- TypeScript compiles without errors
- Built dist/cli.js contains shebang and can display help/version
  </done>
</task>

<task type="auto">
  <name>Task 3: Configure Executable and Test</name>
  <files>package.json</files>
  <action>
**Part A: Add bin field to package.json**

Add bin configuration (research lines 732-768):

```json
{
  "bin": {
    "zoombg": "./dist/cli.js"
  }
}
```

Place after `"main"` field. Path must be relative to package root (research lines 410-434).

**Part B: Update build script**

Modify package.json scripts:
```json
{
  "scripts": {
    "build": "tsc",
    "dev": "tsx src/cli.ts",
    "prepublishOnly": "npm run build"
  }
}
```

Change dev script from `tsx watch src/index.ts` to `tsx src/cli.ts` for easier testing.

**Part C: Link executable locally**

Run:
```bash
npm run build
npm link
```

This creates symlink from `zoombg` command to `dist/cli.js`.

**Part D: Test CLI invocations**

Test all core functionality:

1. Help display:
```bash
zoombg --help
```
Expected: Shows usage, options, examples

2. Version display:
```bash
zoombg --version
```
Expected: Shows version from package.json

3. Invalid service error:
```bash
zoombg "test prompt" --service invalid
```
Expected: Red error message listing valid services, exit code 1

4. Valid service validation (dry run - will fail on Zoom check but should validate service):
```bash
zoombg "test prompt" --service openai
```
Expected: Passes service validation, fails at Zoom verification step (expected)

**Part E: Verify exit codes**

Check exit codes work correctly:
```bash
zoombg --version
echo $?  # Should be 0

zoombg --service invalid "test"
echo $?  # Should be 1
```
  </action>
  <verify>
1. Run `zoombg --help` - displays help documentation
2. Run `zoombg --version` - displays version number
3. Run `zoombg --service invalid "test"` - shows error with exit code 1
4. Check `which zoombg` - points to npm global bin directory
5. Verify package.json contains bin field with correct path
  </verify>
  <done>
- package.json contains bin field pointing to ./dist/cli.js
- npm link creates working zoombg command
- zoombg --help displays usage documentation
- zoombg --version displays version number
- Invalid service shows colored error message and exits with code 1
  </done>
</task>

</tasks>

<verification>
After completing all tasks, verify CLI integration:

1. **Build and link:**
   ```bash
   npm run build && npm link
   ```

2. **Help documentation:**
   ```bash
   zoombg --help
   ```
   Should show: usage, --service option, examples

3. **Version display:**
   ```bash
   zoombg --version
   ```
   Should show: 0.1.0

4. **Service validation:**
   ```bash
   zoombg "test" --service invalid
   echo $?
   ```
   Should show: Error message in red, valid services list in yellow, exit code 1

5. **Valid service (will fail at Zoom check - expected):**
   ```bash
   zoombg "test" --service huggingface
   ```
   Should show: Passes argument parsing, fails at ZoomVerifier (expected in dev)

6. **Check file structure:**
   ```bash
   head -n 1 dist/cli.js  # Should be: #!/usr/bin/env node
   cat package.json | grep -A 2 '"bin"'  # Should show bin config
   ```
</verification>

<success_criteria>
Phase 3 complete when:

1. User can run `zoombg --help` and see usage documentation
2. User can run `zoombg --version` and see version number
3. User can run `zoombg "prompt"` to invoke workflow (fails at Zoom check if not installed)
4. User can run `zoombg "prompt" --service openai` to select service
5. Invalid service shows friendly error with suggestions and exit code 1
6. package.json bin field points to dist/cli.js
7. src/cli.ts has shebang and commander configuration
8. src/workflows/generate.ts accepts WorkflowOptions interface
9. All TypeScript compiles without errors
10. CONFIG-02 requirement satisfied (user can select AI service)
</success_criteria>

<output>
After completion, create `.planning/phases/03-cli-interface/03-01-SUMMARY.md` following template at @/Users/tvellore/.claude/get-shit-done/templates/summary.md
</output>
