---
phase: 02-workflow-orchestration
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/workflows/generate.ts
  - package.json
autonomous: true
requirements: [FLOW-02, FLOW-03, FLOW-04, ZOOM-04]

must_haves:
  truths:
    - "User can input text prompt for image generation"
    - "Tool generates image and opens browser preview automatically"
    - "User sees spinner with progress text during 15-90 second generation"
    - "User can approve image by typing 'yes' at prompt"
    - "User can reject and modify prompt to regenerate"
    - "Approved image is saved to Zoom backgrounds directory"
    - "Tool exits cleanly with all resources cleaned up"
  artifacts:
    - path: "src/workflows/generate.ts"
      provides: "Complete generate→preview→approve→save workflow"
      exports: ["generateWorkflow"]
      min_lines: 100
    - path: "package.json"
      provides: "CLI dependencies for prompts and spinners"
      contains: ["@inquirer/prompts", "ora", "open"]
  key_links:
    - from: "src/workflows/generate.ts"
      to: "src/services/ai/factory.ts"
      via: "createAIService for generation"
      pattern: "createAIService\\('huggingface'\\)"
    - from: "src/workflows/generate.ts"
      to: "src/workflows/preview.ts"
      via: "showPreview for browser display"
      pattern: "await showPreview\\(.*buffer\\)"
    - from: "src/workflows/generate.ts"
      to: "@inquirer/prompts"
      via: "confirm and input for user decisions"
      pattern: "await (confirm|input)\\("
    - from: "src/workflows/generate.ts"
      to: "src/services/zoom/background-manager.ts"
      via: "findBackgroundsDirectory for save location"
      pattern: "await bgManager\\.findBackgroundsDirectory\\(\\)"
    - from: "src/workflows/generate.ts"
      to: "src/utils/cleanup.ts"
      via: "cleanupManager.register for temp file cleanup"
      pattern: "cleanupManager\\.register"
---

<objective>
Orchestrate Phase 1 services into complete user workflow: prompt for image description, generate with AI service, preview in browser, handle approve/reject with optional regeneration, save approved images to Zoom backgrounds directory.

Purpose: Delivers the core user value proposition - "quickly create and set custom Zoom backgrounds using AI without leaving the terminal." Coordinates all Phase 1 services with interactive CLI prompts and progress indicators to create a seamless end-to-end experience.

Output: Working workflow that takes user from prompt to saved Zoom background with iterative refinement capability, progress feedback, and clean error handling.
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-workflow-orchestration/02-RESEARCH.md

# Phase 1 services
@.planning/phases/01-foundation-and-core-services/01-01-SUMMARY.md
@.planning/phases/01-foundation-and-core-services/01-02-SUMMARY.md
@.planning/phases/01-foundation-and-core-services/01-03-SUMMARY.md

# Plan 02-01 outputs (preview system)
@.planning/phases/02-workflow-orchestration/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install CLI dependencies for prompts and spinners</name>
  <files>package.json</files>
  <action>
Install three packages required for interactive workflow:

```bash
npm install @inquirer/prompts ora open
```

**Packages:**
- `@inquirer/prompts` - Modern modular Inquirer rewrite for interactive prompts (confirm, input)
- `ora` (v9.3.0+) - Terminal spinners with reduced flicker and native strip functions
- `open` (v11.0.0+) - Cross-platform file/URL opener for browser preview

**Why these versions:** Research confirms these are current stable versions with required features (RESEARCH.md lines 31-51). `@inquirer/prompts` is the modern ESM-compatible rewrite, `ora` v9.3.0 has reduced flicker improvements, `open` v11 has enhanced WSL support.

**Do NOT:** Install legacy `inquirer` package (monolithic, outdated), install `prompts` or `enquirer` instead (weaker TypeScript support per research alternatives table line 53).
  </action>
  <verify>
Run `npm list @inquirer/prompts ora open` to confirm installation.

Expected output: All three packages listed with version numbers.
  </verify>
  <done>
package.json contains @inquirer/prompts, ora, and open in dependencies, npm install completed successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create workflow orchestrator with iterative prompt loop</name>
  <files>src/workflows/generate.ts</files>
  <action>
Create `src/workflows/generate.ts` that exports `generateWorkflow(): Promise<void>` implementing the complete generate→preview→approve→save flow.

**Implementation structure:**

1. **Imports:**
   - `{ confirm, input }` from '@inquirer/prompts'
   - `{ writeFile, rm }` from 'node:fs/promises'
   - `{ join }` from 'node:path'
   - `ora` from 'ora'
   - `{ createAIService }` from '../services/ai/factory.js'
   - `{ BackgroundManager }` from '../services/zoom/background-manager.js'
   - `{ showPreview }` from './preview.js'
   - `{ cleanupManager }` from '../utils/cleanup.js'

2. **Workflow logic:**
   ```typescript
   export async function generateWorkflow(): Promise<void> {
     let approved = false;
     let currentPrompt = await input({
       message: 'Describe the Zoom background you want:'
     });

     while (!approved) {
       let tempDir: string | undefined;

       try {
         // Generate with spinner
         const spinner = ora('Generating image (may take 15-90 seconds)...').start();
         const aiService = createAIService('huggingface');
         const result = await aiService.generateImage({ prompt: currentPrompt });
         spinner.succeed('Image generated');

         // Preview in browser
         tempDir = await showPreview(result.buffer);

         // Register cleanup
         cleanupManager.register(async () => {
           if (tempDir) await rm(tempDir, { recursive: true, force: true });
         });

         // User approval
         approved = await confirm({
           message: 'Do you approve this image?'
         });

         if (!approved) {
           const shouldModify = await confirm({
             message: 'Do you want to modify the prompt and regenerate?'
           });

           if (shouldModify) {
             currentPrompt = await input({
               message: 'Enter new prompt:',
               default: currentPrompt
             });
           } else {
             console.log('Generation cancelled.');
             return;
           }
         } else {
           // Save approved image
           const saveSpinner = ora('Saving to Zoom backgrounds...').start();
           const bgManager = new BackgroundManager();
           const bgDir = await bgManager.findBackgroundsDirectory();
           const filename = `zoombg-${Date.now()}.png`;
           const savePath = join(bgDir, filename);
           await writeFile(savePath, result.buffer);
           saveSpinner.succeed(`Saved as ${filename}`);
         }
       } catch (error) {
         console.error('Error:', error);
         throw error;
       } finally {
         // Cleanup temp files
         if (tempDir) {
           await rm(tempDir, { recursive: true, force: true }).catch(() => {});
         }
       }
     }
   }
   ```

**Critical patterns from research:**

- **Spinner lifecycle (Research pitfall 4, lines 400-428):** Always `.succeed()` before showing Inquirer prompts to avoid terminal corruption. Wrap in try-catch with `.fail()` on error.

- **Prompt timing (Research pitfall 5, lines 430-449):** Stop spinner completely before calling `confirm()` or `input()` to prevent overlapping output.

- **Cleanup timing (Research pitfall 2, lines 362-378):** Keep temp files until after user approval/rejection decision. Browser needs file to remain loaded during preview viewing.

- **Loop structure (Research Pattern 1, lines 79-141):** While loop with explicit `approved` flag and prompt modification option. Cancel path exits early without save.

**Why this structure:** Explicit state machine with clear exit conditions. User can cancel at any point. Cleanup happens in finally block AND is registered for signal handlers. Spinner provides feedback during long AI generation.

**Do NOT:**
- Call `confirm()` while spinner is running (causes terminal corruption)
- Cleanup temp files immediately after `showPreview()` (browser can't load)
- Use `wait: true` with open (blocks forever, Research pitfall 1)
- Skip error handling on AI generation (user gets unhelpful crash)
- Use atomic write for Zoom save (not needed - not replacing existing file, just adding new one)

**Reference:** Research "Complete Workflow Orchestration" (lines 515-617) for full pattern.
  </action>
  <verify>
Run TypeScript compilation:
```bash
npx tsc --noEmit
```

Expected: No compilation errors.

Then run basic workflow test (will open browser):
```bash
npx tsx -e "import { generateWorkflow } from './src/workflows/generate.js'; console.log('Test: generateWorkflow function exists and is callable')"
```

Expected: Function loads without import errors.
  </verify>
  <done>
generateWorkflow function exists, implements while loop with Inquirer prompts, uses ora spinners with proper lifecycle, calls Phase 1 services (createAIService, BackgroundManager), integrates Plan 02-01 preview system, saves to Zoom directory, registers cleanup, TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Zoom verification check before workflow starts</name>
  <files>src/workflows/generate.ts</files>
  <action>
Update `generateWorkflow()` to verify Zoom installation and login status before proceeding with image generation.

**Add at top of function (before prompting for description):**

```typescript
// Verify Zoom prerequisites
const verifier = new ZoomVerifier();
await verifier.verify(); // Throws ZoomNotInstalledError or ZoomNotLoggedInError
```

**Add import:**
```typescript
import { ZoomVerifier } from '../services/zoom/verifier.js';
```

**Why verify first:** Prevents user from generating image only to discover they can't save it. Fail fast with clear error message from Phase 1 error types (ZoomNotInstalledError has userMessage property).

**Error propagation:** Let verify() throw naturally - CLI will catch and display userMessage in Phase 3. For Phase 2, error propagates to caller.

**Do NOT:** Wrap in try-catch here (let errors bubble), check manually instead of using verify() method, skip verification (wastes user time generating unsaveable images).

**Reference:** Phase 1 Plan 02 SUMMARY (lines 55-65) for ZoomVerifier usage pattern.
  </action>
  <verify>
Run grep to confirm Zoom verification:
```bash
grep -n "await verifier.verify()" src/workflows/generate.ts
```

Expected: Line number showing verify() call before user prompts.

Compile to verify imports:
```bash
npx tsc --noEmit
```

Expected: No errors.
  </verify>
  <done>
generateWorkflow imports ZoomVerifier, calls verify() before prompting user, verification throws clear errors if Zoom not installed or logged in, TypeScript compiles successfully.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Dependency installation:**
```bash
npm list @inquirer/prompts ora open
```
All packages should be listed.

2. **TypeScript compilation:**
```bash
npx tsc --noEmit
```
Should pass with no errors.

3. **Import verification:**
```bash
npx tsx -e "
import { generateWorkflow } from './src/workflows/generate.js';
console.log('✓ generateWorkflow imported successfully');
console.log('✓ Function type:', typeof generateWorkflow);
"
```
Expected: Function type is 'function'.

4. **Workflow structure check:**
```bash
grep -c "while (!approved)" src/workflows/generate.ts
grep -c "ora(" src/workflows/generate.ts
grep -c "await confirm(" src/workflows/generate.ts
grep -c "createAIService" src/workflows/generate.ts
grep -c "BackgroundManager" src/workflows/generate.ts
grep -c "showPreview" src/workflows/generate.ts
```
All should return count > 0.

5. **Manual workflow test (OPTIONAL - requires Zoom installed):**
```bash
npx tsx -e "import { generateWorkflow } from './src/workflows/generate.js'; await generateWorkflow()"
```
This will run actual workflow - only test if you want to generate a real image.
</verification>

<success_criteria>
- [x] @inquirer/prompts, ora, and open installed as dependencies
- [x] generateWorkflow function orchestrates complete workflow
- [x] Workflow verifies Zoom before prompting user
- [x] User can input prompt text via Inquirer input
- [x] Spinner shows progress during AI generation (15-90 seconds)
- [x] Spinner stops completely before showing confirm prompts
- [x] Browser preview opens after generation
- [x] User can approve with confirm prompt
- [x] User can reject and modify prompt to regenerate
- [x] Approved image saves to Zoom backgrounds directory with timestamp filename
- [x] Temp files cleaned up in finally block
- [x] Cleanup registered with cleanupManager for signal handling
- [x] TypeScript compiles without errors
- [x] All verification checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-workflow-orchestration/02-02-SUMMARY.md` documenting:
- Workflow orchestration architecture (state machine, loop structure)
- Integration with Phase 1 services (AI factory, Zoom verifier, BackgroundManager)
- CLI interaction patterns (Inquirer prompts, ora spinners, timing)
- Resource cleanup strategy (finally blocks + signal handlers)
- Any issues with AI generation timing or browser opening
- Testing notes and edge cases discovered
</output>
